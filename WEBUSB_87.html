<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>WebUSB CH340 –¢–µ—Ä–º–∏–Ω–∞–ª</title>
    <style>
        body { font-family: sans-serif; padding: 20px; }
        #output { width: 100%; resize: none; border: 1px solid #ccc; padding: 10px; box-sizing: border-box; }
        #input-container { margin-top: 10px; display: flex; }
        #input-text { flex-grow: 1; padding: 8px; margin-right: 10px; border: 1px solid #ccc; }
        button { padding: 8px 15px; cursor: pointer; }
    </style>
</head>
<body>
    <h1>WebUSB CH340 UART –¢–µ—Ä–º–∏–Ω–∞–ª üõ†Ô∏è</h1>
    <p>‚ö†Ô∏è **–í–ê–ñ–ù–û:** –≠—Ç–æ—Ç –∫–æ–¥ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ç–æ–ª—å–∫–æ –ø–æ **HTTPS** –∏–ª–∏ –Ω–∞ `localhost` –∏ —Ç—Ä–µ–±—É–µ—Ç **—Ä—É—á–Ω–æ–≥–æ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è** –¥–æ—Å—Ç—É–ø–∞ –∫ —É—Å—Ç—Ä–æ–π—Å—Ç–≤—É –≤ –±—Ä–∞—É–∑–µ—Ä–µ.</p>

    <button id="connect-button">–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ CH340</button>
    
    <h3>–í—ã–≤–æ–¥ —Ç–µ—Ä–º–∏–Ω–∞–ª–∞:</h3>
    <textarea id="output" rows="15" readonly></textarea>
    
    <div id="input-container">
        <input type="text" id="input-text" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–º–∞–Ω–¥—É (Enter –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏)...">
        <button id="send-button" disabled>–û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
    </div>

    <script>
	
	// --- –ö–û–ù–°–¢–ê–ù–¢–´ –î–õ–Ø CH340 ---
const USB_VENDOR_ID = 0x1A86; 
const USB_PRODUCT_ID = 0x7523; 
const INTERFACE_NUMBER = 0; 
const ENDPOINT_IN = 2;    // –ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –ø—Ä–∏–µ–º–∞ (–æ—Ç CH340 –∫ –ü–ö)
const ENDPOINT_OUT = 2;   // –ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞ –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ (–æ—Ç –ü–ö –∫ CH340)
const PACKET_SIZE = 64; 

// --- –ü–ï–†–ï–ú–ï–ù–ù–´–ï –°–û–°–¢–û–Ø–ù–ò–Ø ---
let device;
let isConnected = false;

// --- DOM –≠–õ–ï–ú–ï–ù–¢–´ ---
const connectButton = document.getElementById('connect-button');
const sendButton = document.getElementById('send-button');
const outputArea = document.getElementById('output');
const inputText = document.getElementById('input-text');

// --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–û–ë–´–¢–ò–ô ---
connectButton.addEventListener('click', connect);
sendButton.addEventListener('click', sendData);
inputText.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !sendButton.disabled) {
        sendData();
    }
});

// ----------------------------------------------------
// –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò
// ----------------------------------------------------

function log(message) {
    const timestamp = new Date().toLocaleTimeString();
    outputArea.value += `[${timestamp}] ${message}\n`;
    outputArea.scrollTop = outputArea.scrollHeight;
}

function updateConnectionStatus(status) {
    isConnected = status;
    connectButton.textContent = status ? '–ü–æ–¥–∫–ª—é—á–µ–Ω–æ' : '–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ CH340';
    connectButton.disabled = status;
    sendButton.disabled = !status;
}

// ----------------------------------------------------
// –ù–ê–°–¢–†–û–ô–ö–ê CH340 (–ù–ò–ó–ö–û–£–†–û–í–ù–ï–í–´–ï –ö–û–ú–ê–ù–î–´)
// ----------------------------------------------------

async function configureCH340() {
    // –í–Ω–∏–º–∞–Ω–∏–µ: –≠—Ç–∏ –∫–æ–º–∞–Ω–¥—ã —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã –¥–ª—è —á–∏–ø–∞ CH340.
    // –û–Ω–∏ –∏–º–∏—Ç–∏—Ä—É—é—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—é, –∫–æ—Ç–æ—Ä—É—é –≤—ã–ø–æ–ª–Ω—è–µ—Ç –¥—Ä–∞–π–≤–µ—Ä.
    
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è (Get Version)
    log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –®–∞–≥ 1 (–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è)...');
    await device.controlTransferOut({
        requestType: 'vendor',
        recipient: 'device',
        request: 0xA1,
        value: 0x1312,
        index: 0x0000
    });

    // 2. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ—Ä—Ç–∞
    log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –®–∞–≥ 2 (–ü–æ—Ä—Ç)...');
    await device.controlTransferOut({
        requestType: 'vendor',
        recipient: 'device',
        request: 0x9A,
        value: 0x2518,
        index: 0x0050
    });

    // 3. –£—Å—Ç–∞–Ω–æ–≤–∫–∞ —Å–∫–æ—Ä–æ—Å—Ç–∏ (Baud Rate 9600)
    // –≠—Ç–∏ –∑–Ω–∞—á–µ–Ω–∏—è —Å–ª–æ–∂–Ω—ã, –∑–∞–≤–∏—Å—è—Ç –æ—Ç –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π —Å–∫–æ—Ä–æ—Å—Ç–∏ –∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞. 
    // –î–ª—è 9600 –±–æ–¥ —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É—é—Ç—Å—è: Value: 0x1A20, Index: 0x00C0
    log('–ù–∞—Å—Ç—Ä–æ–π–∫–∞: –®–∞–≥ 3 (–°–∫–æ—Ä–æ—Å—Ç—å 9600 –±–æ–¥)...');
    await device.controlTransferOut({
        requestType: 'vendor',
        recipient: 'device',
        request: 0x9A,
        value: 0x1A20, 
        index: 0x00C0
    });
    
    log('CH340 –Ω–∞—Å—Ç—Ä–æ–µ–Ω (–±–∞–∑–æ–≤—ã–π –±–æ–¥-—Ä–µ–π—Ç 9600).');
}

// ----------------------------------------------------
// –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–ï
// ----------------------------------------------------

async function connect() {
    try {
        // 1. –ó–∞–ø—Ä–æ—Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
        device = await navigator.usb.requestDevice({
            filters: [{ vendorId: USB_VENDOR_ID, productId: USB_PRODUCT_ID }]
        });
        
        log(`–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–∞–π–¥–µ–Ω–æ: ${device.productName} (VID: 0x${USB_VENDOR_ID.toString(16)}, PID: 0x${USB_PRODUCT_ID.toString(16)})`);

        // 2. –û—Ç–∫—Ä—ã—Ç–∏–µ, –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è –∏ –∑–∞—Ö–≤–∞—Ç –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        await device.open();
        await device.selectConfiguration(1);
        await device.claimInterface(INTERFACE_NUMBER);
        log(`–ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å ${INTERFACE_NUMBER} –∑–∞–ø—Ä–æ—à–µ–Ω.`);

        // 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ CH340
        await configureCH340(); 

        // 4. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –∏ –∑–∞–ø—É—Å–∫ —á—Ç–µ–Ω–∏—è
        updateConnectionStatus(true);
        readDataLoop();
    } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`);
        updateConnectionStatus(false);
    }
}

// ----------------------------------------------------
// –û–¢–ü–†–ê–í–ö–ê –î–ê–ù–ù–´–•
// ----------------------------------------------------

async function sendData() {
    if (!isConnected || !device) {
        log('–û—à–∏–±–∫–∞: –£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ.');
        return;
    }

    const text = inputText.value + '\n'; // –î–æ–±–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–≤–æ–¥ —Å—Ç—Ä–æ–∫–∏
    const encoder = new TextEncoder();
    const data = encoder.encode(text);

    try {
        // transferOut - –¥–ª—è –ø–µ—Ä–µ–¥–∞—á–∏ –¥–∞–Ω–Ω—ã—Ö
        const result = await device.transferOut(ENDPOINT_OUT, data);
        log(`> –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ: "${text.trim()}" (${result.bytesTransferred} –±–∞–π—Ç)`);
        inputText.value = '';
    } catch (error) {
        log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ: ${error.message}`);
    }
}

// ----------------------------------------------------
// –ü–û–õ–£–ß–ï–ù–ò–ï –î–ê–ù–ù–´–• (–¶–ò–ö–õ)
// ----------------------------------------------------

async function readDataLoop() {
    if (!isConnected || !device) return;

    try {
        while (isConnected) {
            // transferIn - –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö —Å —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            const result = await device.transferIn(ENDPOINT_IN, PACKET_SIZE);
            
            if (result.status === 'ok' && result.data && result.data.byteLength > 0) {
                const decoder = new TextDecoder();
                const text = decoder.decode(result.data);
                log(text.trim());
            } else if (result.status === 'stalled') {
                // Endpoint –±—ã–ª –∑–∞—Å—Ç–æ–ø–æ—Ä–µ–Ω, –Ω—É–∂–Ω–æ —Å–±—Ä–æ—Å–∏—Ç—å
                await device.clearHalt('in', ENDPOINT_IN);
            }
        }
    } catch (error) {
        if (isConnected) { 
            log(`‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è: ${error.message}`);
        }
    } finally {
        // –û—á–∏—Å—Ç–∫–∞ –ø—Ä–∏ —Ä–∞–∑—Ä—ã–≤–µ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è
        if (isConnected) {
            disconnect();
        }
    }
}

// ----------------------------------------------------
// –û–¢–ö–õ–Æ–ß–ï–ù–ò–ï
// ----------------------------------------------------

async function disconnect() {
    if (device) {
        try {
            // –û—Å–≤–æ–±–æ–∂–¥–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –∏ –∑–∞–∫—Ä—ã—Ç–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞
            await device.releaseInterface(INTERFACE_NUMBER);
            await device.close();
            log('–°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ.');
        } catch (error) {
            log(`‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫–ª—é—á–µ–Ω–∏–∏: ${error.message}`);
        }
    }
    updateConnectionStatus(false);
}
	</script>
</body>
</html>